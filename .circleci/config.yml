---
version: 2
jobs:
    build-dist:
      docker:
          - image: node:16-alpine3.14
      steps:
          - checkout
          - run:
                name: Installation des dépendances
                command: |
                  npm install
          - run:
              name: Génération du build
              command: |
                npm run build
          - run:
              name: Réécriture des urls des fichiers dans l'index pour les github pages
              command: |
                sed -e 's|/css/app.css|css/app.css|g' -i index.html
                sed -e 's|/js/app.js|js/app.js|g' -i index.html
          - persist_to_workspace:
              root: ./
              paths: dist

    deploy-github-pages:
      build-dist:
      docker:
          - image: node:16-alpine3.14
      steps:
          - attach_workspace:
              at: ./
          - run:
              name: Install and configure dependencies
              command: |
                npm install -g --silent gh-pages@2.0.1
                git config user.email "circleci@dashboard-widget"
                git config user.name "CircleCI"
          - run:
              name: Deploy docs to gh-pages branch
              command: gh-pages --dist ./dist
              
workflows:
    version: 2
    gh-pages:
      jobs:
        - build-dist
            filters:
              branches:
                only:
                  - master
        - deploy-github-pages
            requires:
              - build-dist
            filters:
              branches:
                only:
                  - master